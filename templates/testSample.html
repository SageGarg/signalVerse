<!DOCTYPE html>
<html>
  <head>
    <title>Reports</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 10px;
        background: #f8f9fa;
      }
      h1 {
        color: #333;
        text-align: center;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        background: white;
        table-layout: fixed;
      }
      th,
      td {
        padding: 8px;
        border: 1px solid #ccc;
        text-align: left;
        vertical-align: top;
      }
      th {
        background: #343a40;
        color: white;
      }
      tr:nth-child(even) {
        background: #f2f2f2;
      }
      select,
      button,
      input[type="file"] {
        margin-right: 10px;
        padding: 4px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 14px;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
        transition: 0.3s;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .table-container {
        max-height: 350px;
        overflow-y: auto;
        margin-top: 20px;
        border: 1px solid #ccc;
        background: white;
        border-radius: 6px;
      }
      /* Sticky Table Header */
      .table-container table thead th {
        position: sticky;
        top: 0;
        background: #343a40;
        color: white;
        z-index: 10;
      }
      .muted {
        color: #666;
        font-size: 12px;
      }
      .sensorFunctionSelect,
      .performanceMeasureSelect {
        width: 100%;
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
    </style>
  </head>

  <body>
    {% with messages = get_flashed_messages() %} {% if messages %}
    <div
      style="
        background: #ffdddd;
        padding: 12px 18px;
        border-left: 4px solid #d9534f;
        color: #a94442;
        border-radius: 4px;
        width: 90%;
        margin: 15px auto;
        font-weight: bold;
        text-align: center;
      "
    >
      {{ messages[0] }}
    </div>
    {% endif %} {% endwith %}

    <h1>Test Results Summary</h1>
    <div style="text-align: right; margin-top: 10px">
      <a
        href="{{ url_for('nchrp_bp.index_nchrp') }}"
        style="text-decoration: none; color: #007bff; font-weight: bold"
      >
        ‚Üê Back to NCHRP Home
      </a>
    </div>

    <!-- ======= TOP TOOLBAR ======= -->
    <div
      style="
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
      "
    >
      <!-- Download Template CSV button -->
      <button
        type="button"
        onclick="downloadTemplateCSV()"
        style="
          background: #6c757d;
          padding: 6px 14px;
          border-radius: 6px;
          color: white;
          border: none;
          cursor: pointer;
        "
      >
        Download Template CSV
      </button>

      <!-- Upload Button -->
      <form
        action="{{ url_for('nchrp_bp.upload_report') }}"
        method="POST"
        enctype="multipart/form-data"
        style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap"
      >
        <label for="pdf_file" style="font-weight: bold"
          >Upload Excel/CSV:</label
        >
        <input
          type="file"
          id="pdf_file"
          name="pdf_file"
          accept=".xlsx,.csv"
          required
        />

        <button type="submit" class="btn" style="background: #1a73e8">
          Upload
        </button>
        <span class="muted">(.xlsx or .csv)</span>
      </form>

      <!-- Download CSV button -->
      <button
        type="button"
        onclick="downloadTableAsCSV()"
        style="
          background: #28a745;
          padding: 6px 14px;
          border-radius: 6px;
          color: white;
          border: none;
          cursor: pointer;
        "
      >
        Download CSV
      </button>
    </div>

    <br />

    <!-- Filter Section -->
    <div style="margin-bottom: 15px">
      <label>Year:</label>
      <select id="yearFilter">
        <option value="">All</option>
        {% for year in range(2025, 1999, -1) %}
        <option value="{{ year }}">{{ year }}</option>
        {% endfor %}
      </select>

      <label>Stage:</label>
      <select id="stageFilter">
        <option value="">All</option>
        <option value="Stage 1 Level 1">Stage 1 Level 1</option>
        <option value="Stage 1 Level 2">Stage 1 Level 2</option>
        <option value="Stage 2">Stage 2</option>
      </select>

      <label>State:</label>
      <select id="stateFilter">
        <option value="">All</option>
        {% set states = [] %} {% for test in tests %} {% set st = test["Test
        Location (State)"] or "" %} {% if st and st not in states %} {% set _ =
        states.append(st) %}
        <option value="{{ st }}">{{ st }}</option>
        {% endif %} {% endfor %}
      </select>

      <label>Sensor Technology:</label>
      <select id="sensorFilter">
        <option value="">All</option>
        {% set sensors = [] %} {% for test in tests %} {% set tech =
        test["Sensor Technology"] or "" %} {% if tech and tech not in sensors %}
        {% set _ = sensors.append(tech) %}
        <option value="{{ tech }}">{{ tech }}</option>
        {% endif %} {% endfor %}
      </select>

      <button
        onclick="resetFilters()"
        style="background: #dc3545; color: white"
      >
        Reset Filters
      </button>
    </div>

    <!-- Data Table (SUMMARY ONLY) -->
    <div class="table-container">
      <table id="reportTable">
        <thead>
          <tr>
            <th>Test ID</th>
            <th>Vendor Name</th>
            <th>Sensor model name</th>
            <th>Sensor Technology</th>
            <th>Stage &amp; Level</th>
            <th>Test Center</th>
            <th>Test Location (State)</th>
            <th>Date of Testing</th>
            <th>Ground Truth Source</th>

            <th>Sensor Function</th>
            <th>Performance Measure</th>
            <th>Details</th>
          </tr>
        </thead>

        <tbody id="tableBody">
          {% for test in tests %}
          <!-- SUMMARY ROW -->
          <tr
            class="summary-row"
            data-filtered="visible"
            data-test-id="{{ test['Test ID'] }}"
            data-metrics='{{ (metrics.get((test["Test ID"] ~ ""), [])) | tojson }}'
          >
            <td>{{ test["Test ID"] }}</td>
            <td>{{ test["Vendor Name"] }}</td>
            <td>{{ test["Sensor model name"] }}</td>
            <td>{{ test["Sensor Technology"] }}</td>
            <td>{{ test["Stage & Level"] }}</td>
            <td>{{ test["Test Center"] }}</td>
            <td>{{ test["Test Location (State)"] }}</td>
            <td>{{ test["Date of Testing"] }}</td>
            <td>{{ test["Ground Truth Source"] }}</td>

            <td>
              <select class="sensorFunctionSelect">
                <option value="">Select‚Ä¶</option>
              </select>
            </td>

            <td>
              <select class="performanceMeasureSelect" disabled>
                <option value="">Select‚Ä¶</option>
              </select>
            </td>

            <td>
              <button type="button" class="toggleDetailsBtn" disabled>
                View
              </button>
            </td>
          </tr>

          <!-- DETAIL ROW (hidden by default) -->
          <tr class="detail-row" style="display: none">
            <td colspan="12">
              <div
                class="detail-box"
                style="
                  padding: 12px;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  background: #fafafa;
                "
              >
                <div
                  class="detail-title"
                  style="font-weight: bold; margin-bottom: 10px"
                ></div>

                <table
                  style="
                    width: 100%;
                    border-collapse: collapse;
                    background: white;
                  "
                >
                  <thead>
                    <tr>
                      <th style="padding: 8px; border: 1px solid #ddd">
                        Measured value (%)
                      </th>
                      <th style="padding: 8px; border: 1px solid #ddd">
                        Sample size
                      </th>
                      <th style="padding: 8px; border: 1px solid #ddd">
                        Weather (F)
                      </th>
                      <th style="padding: 8px; border: 1px solid #ddd">
                        Lighting
                      </th>
                      <th style="padding: 8px; border: 1px solid #ddd">
                        Testing Notes
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td
                        class="mv"
                        style="padding: 8px; border: 1px solid #ddd"
                      ></td>
                      <td
                        class="ss"
                        style="padding: 8px; border: 1px solid #ddd"
                      ></td>
                      <td
                        class="wf"
                        style="padding: 8px; border: 1px solid #ddd"
                      ></td>
                      <td
                        class="li"
                        style="padding: 8px; border: 1px solid #ddd"
                      ></td>
                      <td
                        class="tn"
                        style="padding: 8px; border: 1px solid #ddd"
                      ></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div
      id="paginationControls"
      style="margin-top: 15px; text-align: center"
    ></div>

    <!-- Chatbot Section -->
    <div
      style="
        margin-top: 40px;
        padding: 20px;
        background: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
      "
    >
      <h2 style="text-align: center; margin-bottom: 15px">
        Ask the Report Assistant ü§ñ
      </h2>

      <form id="chatForm" onsubmit="sendQuestion(event)">
        <input
          type="text"
          id="userInput"
          placeholder="Ask a question about any report‚Ä¶"
          style="
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 16px;
          "
          required
        />
        <button
          style="
            background: #007bff;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
          "
        >
          Submit
        </button>
      </form>

      <div
        id="chatOutput"
        style="
          margin-top: 20px;
          padding: 15px;
          background: #f8f9fa;
          border-radius: 6px;
          min-height: 80px;
          white-space: pre-wrap;
        "
      ></div>
    </div>

    <script>
      // ----------------------------
      // Filters (SUMMARY ROWS only)
      // ----------------------------
      function applyFilters() {
        const year = document.getElementById("yearFilter").value;
        const stage = document
          .getElementById("stageFilter")
          .value.toLowerCase();
        const state = document
          .getElementById("stateFilter")
          .value.toLowerCase();
        const sensor = document
          .getElementById("sensorFilter")
          .value.toLowerCase();

        const summaryRows = document.querySelectorAll(
          "#tableBody .summary-row"
        );

        summaryRows.forEach((row) => {
          const cells = row.querySelectorAll("td");

          const techText = (cells[3]?.innerText || "").toLowerCase(); // Sensor Technology
          const stageText = (cells[4]?.innerText || "").toLowerCase(); // Stage & Level
          const stateText = (cells[6]?.innerText || "").toLowerCase(); // Test Location (State)
          const dateText = cells[7]?.innerText || ""; // Date of Testing

          const rowYearMatch = dateText.match(/\b(20\d{2}|19\d{2})\b/);
          const rowYear = rowYearMatch ? rowYearMatch[0] : "";

          const matches =
            (!year || rowYear === year) &&
            (!stage || stageText.includes(stage)) &&
            (!state || stateText.includes(state)) &&
            (!sensor || techText.includes(sensor));

          row.dataset.filtered = matches ? "visible" : "hidden";

          // If filtering out, also close detail row
          const detailRow = row.nextElementSibling;
          if (
            detailRow &&
            detailRow.classList.contains("detail-row") &&
            !matches
          ) {
            detailRow.style.display = "none";
            const btn = row.querySelector(".toggleDetailsBtn");
            if (btn) btn.textContent = "View";
          }
        });

        currentPage = 1;
        paginateTable();
      }

      function resetFilters() {
        document.getElementById("yearFilter").value = "";
        document.getElementById("stageFilter").value = "";
        document.getElementById("stateFilter").value = "";
        document.getElementById("sensorFilter").value = "";
        applyFilters();
      }

      document.addEventListener("DOMContentLoaded", () => {
        ["yearFilter", "stageFilter", "stateFilter", "sensorFilter"].forEach(
          (id) => {
            document
              .getElementById(id)
              .addEventListener("change", applyFilters);
          }
        );
      });
    </script>

    <script>
      // ----------------------------
      // Download visible (filtered) SUMMARY rows as CSV
      // ----------------------------
      function csvEscape(text) {
        text = (text ?? "")
          .toString()
          .replace(/(\r\n|\n|\r)/gm, " ")
          .trim();
        if (text.includes('"') || text.includes(",")) {
          text = `"${text.replace(/"/g, '""')}"`;
        }
        return text;
      }

      function downloadTableAsCSV() {
        const headerRow = document.querySelector("#reportTable thead tr");
        const headers = Array.from(headerRow.querySelectorAll("th")).map((th) =>
          csvEscape(th.innerText)
        );

        const summaryRows = Array.from(
          document.querySelectorAll("#tableBody .summary-row")
        ).filter((r) => r.dataset.filtered !== "hidden");

        if (summaryRows.length === 0) {
          alert("No data available to download.");
          return;
        }

        const csv = [];
        csv.push(headers.join(","));

        summaryRows.forEach((row) => {
          const cols = row.querySelectorAll("td");
          const rowData = Array.from(cols)
            .slice(0, 12)
            .map((td) => csvEscape(td.innerText));
          csv.push(rowData.join(","));
        });

        const blob = new Blob([csv.join("\n")], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        const timestamp = new Date().toISOString().split("T")[0];
        link.href = URL.createObjectURL(blob);
        link.download = `stage_reports_${timestamp}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    </script>

    <script>
      // ----------------------------
      // Pagination (SUMMARY ROWS only)
      // ----------------------------
      let currentPage = 1;
      const rowsPerPage = 5;

      function getFilteredSummaryRows() {
        return Array.from(
          document.querySelectorAll("#tableBody .summary-row")
        ).filter((row) => row.dataset.filtered !== "hidden");
      }

      function paginateTable() {
        const summaryRows = getFilteredSummaryRows();
        const totalRows = summaryRows.length;
        const totalPages = Math.max(1, Math.ceil(totalRows / rowsPerPage));

        if (currentPage > totalPages) currentPage = totalPages;

        // Hide all rows first (both summary + detail)
        document
          .querySelectorAll("#tableBody .summary-row, #tableBody .detail-row")
          .forEach((row) => {
            row.style.display = "none";
          });

        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        summaryRows.slice(start, end).forEach((summaryRow) => {
          summaryRow.style.display = "";

          // Only show detail row if it was opened (display != none)
          const detailRow = summaryRow.nextElementSibling;
          const btn = summaryRow.querySelector(".toggleDetailsBtn");
          if (detailRow && detailRow.classList.contains("detail-row")) {
            if (btn && btn.textContent.trim() === "Hide") {
              detailRow.style.display = "";
            } else {
              detailRow.style.display = "none";
            }
          }
        });

        updatePaginationControls(totalPages);
      }

      function updatePaginationControls(totalPages) {
        const container = document.getElementById("paginationControls");
        container.innerHTML = `
          <button onclick="goToPage(${currentPage - 1})" ${
          currentPage === 1 ? "disabled" : ""
        }>&laquo; Prev</button>
          Page ${currentPage} of ${totalPages}
          <button onclick="goToPage(${currentPage + 1})" ${
          currentPage === totalPages ? "disabled" : ""
        }>Next &raquo;</button>
        `;

        container.querySelectorAll("button").forEach((btn) => {
          btn.style.padding = "6px 12px";
          btn.style.margin = "0 4px";
          btn.style.borderRadius = "6px";
          btn.style.border = "1px solid #ccc";
          btn.style.cursor = "pointer";
          btn.style.background = "#007bff";
          btn.style.color = "white";
        });
      }

      function goToPage(page) {
        currentPage = page;
        paginateTable();
      }

      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("#tableBody .summary-row").forEach((row) => {
          row.dataset.filtered = "visible";
        });
        paginateTable();
      });
    </script>

    <script>
      // ----------------------------
      // Chat
      // ----------------------------
      async function sendQuestion(event) {
        event.preventDefault();

        const question = document.getElementById("userInput").value;
        const output = document.getElementById("chatOutput");

        output.innerHTML = `<strong>Question:</strong> ${question}<br><br>‚è≥ Thinking‚Ä¶`;

        const response = await fetch("{{ url_for('nchrp_bp.ask_ai') }}", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question }),
        });

        const data = await response.json();

        if (data.error) {
          output.innerHTML = `<span style="color:red;">${data.error}</span>`;
          return;
        }

        output.innerHTML = `<p><strong>AI Answer:</strong></p><p>${data.answer}</p><br>`;

        const btn = document.createElement("button");
        btn.textContent = "‚¨á Download Matched Rows (CSV)";
        btn.style.background = "#28a745";
        btn.style.color = "white";
        btn.style.padding = "8px 15px";
        btn.style.border = "none";
        btn.style.borderRadius = "5px";
        btn.style.cursor = "pointer";

        btn.addEventListener("click", () => {
          downloadMatchedCSV(data.columns, data.matched_rows);
        });

        output.appendChild(btn);
      }

      function downloadMatchedCSV(columns, rows) {
        if (!columns || !rows) {
          alert("No matched rows available to download.");
          return;
        }

        const csv = [];
        csv.push(columns.map(csvEscape).join(","));

        rows.forEach((obj) => {
          const rowArray = columns.map((col) => csvEscape(obj[col] ?? ""));
          csv.push(rowArray.join(","));
        });

        const blob = new Blob([csv.join("\n")], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "matched_reports.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    </script>

    <script>
      // ----------------------------
      // Template CSV download (headers only)
      // ----------------------------
      function downloadTemplateCSV() {
        const columns = {{ column_headers | tojson }};
        const csv = [columns.map(csvEscape).join(",")];

        const blob = new Blob([csv.join("\n")], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "template.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    </script>

    <script>
      // ----------------------------
      // Drilldown: dynamic dropdowns from per-test metrics (Excel-driven)
      // ----------------------------
      function safeParseJson(str) {
        try {
          return JSON.parse(str || "[]");
        } catch {
          return [];
        }
      }

      function uniq(arr) {
        return Array.from(
          new Set(
            (arr || [])
              .filter(
                (x) => x !== null && x !== undefined && String(x).trim() !== ""
              )
              .map((x) => String(x).trim())
          )
        );
      }

      function setOptions(selectEl, options) {
        selectEl.innerHTML = '<option value="">Select‚Ä¶</option>';
        options.forEach((opt) => {
          const o = document.createElement("option");
          o.value = opt;
          o.textContent = opt;
          selectEl.appendChild(o);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        const summaryRows = document.querySelectorAll(
          "#tableBody .summary-row"
        );

        summaryRows.forEach((summaryRow) => {
          const detailRow = summaryRow.nextElementSibling;
          const metrics = safeParseJson(summaryRow.dataset.metrics);

          const funcSel = summaryRow.querySelector(".sensorFunctionSelect");
          const perfSel = summaryRow.querySelector(".performanceMeasureSelect");
          const viewBtn = summaryRow.querySelector(".toggleDetailsBtn");

          // Populate Sensor Function options from metrics in Excel
          const functions = uniq(metrics.map((m) => m["Sensor Function"]));
          setOptions(funcSel, functions);

          funcSel.addEventListener("change", () => {
            const func = funcSel.value;

            const measures = uniq(
              metrics
                .filter(
                  (m) => String(m["Sensor Function"] || "").trim() === func
                )
                .map((m) => m["Performance Measure"])
            );

            setOptions(perfSel, measures);
            perfSel.disabled = measures.length === 0;
            viewBtn.disabled = true;

            if (detailRow) detailRow.style.display = "none";
            viewBtn.textContent = "View";
          });

          perfSel.addEventListener("change", () => {
            viewBtn.disabled = !perfSel.value;
            if (detailRow) detailRow.style.display = "none";
            viewBtn.textContent = "View";
          });

          viewBtn.addEventListener("click", () => {
            const func = funcSel.value;
            const measure = perfSel.value;
            if (!func || !measure) return;

            const isOpen = detailRow.style.display !== "none";
            if (isOpen) {
              detailRow.style.display = "none";
              viewBtn.textContent = "View";
              return;
            }

            // Find metric row matching selection
            const row = metrics.find(
              (m) =>
                String(m["Sensor Function"] || "").trim() === func &&
                String(m["Performance Measure"] || "").trim() === measure
            );

            const box = detailRow.querySelector(".detail-box");
            box.querySelector(
              ".detail-title"
            ).textContent = `${func} ‚Üí ${measure}`;

            box.querySelector(".mv").textContent =
              row?.["Measured value (%)"] ?? "";
            box.querySelector(".ss").textContent = row?.["Sample size"] ?? "";
            box.querySelector(".wf").textContent = row?.["Weather (F)"] ?? "";
            box.querySelector(".li").textContent = row?.["Lighting"] ?? "";
            box.querySelector(".tn").textContent =
              row?.["Testing Notes (optional)"] ?? "";

            detailRow.style.display = "";
            viewBtn.textContent = "Hide";

            // If detail row is now open, make sure pagination didn't hide it
            // (paginateTable respects "Hide" state)
          });
        });
      });
    </script>
  </body>
</html>
